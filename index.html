<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CasaRetro Roulette - Drive Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <!-- DELETED: Redundant Google API script removed from here -->
    
    <script>
        // Tailwind Config
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'pixel': ['VT323', 'monospace'] },
                    colors: {
                        'arcade-black': '#1a1a1a', 'arcade-bg': '#2c2c3a',
                        'arcade-blue': '#00a8f3', 'arcade-pink': '#f72585',
                        'arcade-purple': '#7209b7', 'arcade-gray': '#4a4a5a',
                        'arcade-light': '#f0f0f0',
                    },
                    boxShadow: {
                        'pixel-sm': '4px 4px 0px 0px rgba(0,0,0,1)',
                        'pixel-md': '6px 6px 0px 0px rgba(0,0,0,1)',
                        'neon': '0 0 5px #f72585, 0 0 10px #f72585, 0 0 15px #f72585',
                    }
                }
            }
        }
    </script>

    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'pixel', monospace;
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(22, 6, 37, 0.9), rgba(44, 44, 58, 0.9)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            color: #f0f0f0;
            text-shadow: 2px 2px #000;
        }
        .main-container {
            border: 4px solid #1a1a1a;
            box-shadow: inset 0 0 0 4px #4a4a5a, 0 0 20px rgba(247, 37, 133, 0.3);
        }
        .wheel-container::before {
            content: ''; position: absolute; top: -20px; left: 50%;
            transform: translateX(-50%); width: 0; height: 0;
            border-left: 20px solid transparent; border-right: 20px solid transparent;
            border-bottom: 30px solid #f72585; filter: drop-shadow(0 4px 0 #000); z-index: 10;
        }
        #roulette-wheel {
            border-radius: 50%; border: 8px solid #1a1a1a;
            box-shadow: inset 0 0 0 8px #4a4a5a, 0 0 25px rgba(0, 168, 243, 0.5);
        }
        #spin-button {
            width: 80px; height: 80px; background-color: #f72585; border: 4px solid #1a1a1a;
            box-shadow: inset 0 0 0 4px #4a4a5a, 0 8px 0 0 #7209b7;
            transition: all 0.1s ease-in-out;
        }
        #spin-button:active {
            transform: translate(-50%, -50%) translateY(4px);
            box-shadow: inset 0 0 0 4px #4a4a5a, 0 4px 0 0 #7209b7;
        }
        .pixel-input, .pixel-button {
            border: 4px solid #1a1a1a; box-shadow: inset 0 0 0 4px #4a4a5a;
            background-color: #2c2c3a; padding: 10px 16px; font-size: 1.25rem;
            transition: all 0.2s ease;
        }
        .pixel-input:focus { outline: none; box-shadow: inset 0 0 0 4px #00a8f3; }
        .pixel-button { cursor: pointer; box-shadow: 4px 4px 0px 0px #1a1a1a; }
        .pixel-button:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0px 0px #1a1a1a; }
        .pixel-button:active:not(:disabled) { transform: translate(4px, 4px); box-shadow: 0px 0px 0px 0px #1a1a1a; }
        .cover-item img {
            border: 4px solid #1a1a1a; box-shadow: inset 0 0 0 4px #4a4a5a;
            transition: all 0.2s ease; image-rendering: pixelated;
        }
        .cover-item.in-wheel img {
            opacity: 1; transform: scale(1.05);
            box-shadow: inset 0 0 0 4px #00a8f3, 0 0 15px rgba(0, 168, 243, 0.7);
        }
        .cover-item:not(.in-wheel) img { opacity: 0.4; filter: grayscale(80%); }
        .modal-content {
            border: 4px solid #1a1a1a;
            box-shadow: inset 0 0 0 4px #4a4a5a, 0 0 30px rgba(247, 37, 133, 0.5);
        }
        /* Google Drive Modal Styles */
        .drive-item {
            cursor: pointer; transition: background-color 0.2s;
            border: 2px solid #4a4a5a;
        }
        .drive-item:hover { background-color: #4a4a5a; }
    </style>
</head>
<body class="font-pixel text-arcade-light text-xl">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        
        <header class="text-center mb-12">
            <h1 class="text-6xl md:text-8xl font-black uppercase text-arcade-pink tracking-widest" style="text-shadow: 4px 4px #7209b7;">
                CasaRetro Roulette
            </h1>
            <p class="text-arcade-blue mt-4 text-2xl">SELECT YOUR FIGHTER</p>
        </header>

        <main class="flex flex-col lg:flex-row items-center justify-center gap-12">
            <div class="flex flex-col items-center">
                <div class="wheel-container relative w-[320px] h-[320px] sm:w-[500px] sm:h-[500px]">
                    <canvas id="roulette-wheel" width="500" height="500"></canvas>
                    <button id="spin-button" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 rounded-full z-10"></button>
                </div>
            </div>

            <section class="w-full max-w-md bg-arcade-bg p-6 main-container">
                <h2 class="text-3xl font-bold mb-6 text-center uppercase">INSERT COIN</h2>
                <div class="flex flex-col gap-4">
                    <input type="text" id="game-name-input" placeholder="Game Name..." class="pixel-input w-full">
                    <input type="file" id="game-cover-input" accept="image/*" class="text-arcade-gray file:text-xl">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                    <button id="add-game-button" class="pixel-button bg-arcade-blue text-arcade-black">ADD GAME</button>
                    <button id="reset-button" class="pixel-button bg-arcade-pink text-arcade-black">CLEAR WHEEL</button>
                </div>
                <!-- UPDATED: Google Drive Button starts disabled -->
                <div class="mt-6">
                    <button id="drive-connect-button" class="pixel-button bg-green-500 text-arcade-black w-full disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Loading Drive...
                    </button>
                </div>
            </section>
        </main>

        <footer class="mt-16 bg-arcade-bg p-6 main-container">
             <h2 class="text-4xl font-bold mb-6 text-center uppercase">Game Library</h2>
            <div id="covers-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </footer>

    </div>
    
    <!-- Winner Modal -->
    <div id="winner-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-arcade-bg text-center p-8 max-w-md w-full">
            <h2 class="text-4xl font-bold text-arcade-blue mb-4 uppercase">WINNER!</h2>
            <img id="winner-cover" src="" alt="Portada del ganador" class="w-full mb-4" style="aspect-ratio: 3 / 4; object-fit: cover; border: 4px solid #1a1a1a; box-shadow: inset 0 0 0 4px #4a4a5a;">
            <h3 id="winner-name" class="text-5xl font-black uppercase text-arcade-pink" style="text-shadow: 3px 3px #7209b7;"></h3>
            <button id="close-modal-button" class="mt-8 pixel-button bg-arcade-purple text-arcade-light">PLAY AGAIN</button>
        </div>
    </div>

    <!-- Google Drive Modal -->
    <div id="drive-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-arcade-bg p-6 max-w-3xl w-full h-4/5 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-arcade-blue uppercase">Google Drive</h2>
                <button id="close-drive-modal-button" class="text-4xl">&times;</button>
            </div>
            <div id="drive-breadcrumbs" class="flex gap-2 mb-4 text-arcade-gray"></div>
            <div id="drive-files" class="flex-grow overflow-y-auto bg-arcade-black p-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                <!-- Drive files will be listed here -->
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES ---
            const canvas = document.getElementById('roulette-wheel');
            const ctx = canvas.getContext('2d');
            const spinButton = document.getElementById('spin-button');
            const addGameButton = document.getElementById('add-game-button');
            const gameNameInput = document.getElementById('game-name-input');
            const gameCoverInput = document.getElementById('game-cover-input');
            const coversGallery = document.getElementById('covers-gallery');
            const resetButton = document.getElementById('reset-button');
            const winnerModal = document.getElementById('winner-modal');
            const winnerCover = document.getElementById('winner-cover');
            const winnerName = document.getElementById('winner-name');
            const closeModalButton = document.getElementById('close-modal-button');
            
            // --- GOOGLE DRIVE DOM REFERENCES ---
            const driveConnectButton = document.getElementById('drive-connect-button');
            const driveModal = document.getElementById('drive-modal');
            const closeDriveModalButton = document.getElementById('close-drive-modal-button');
            const driveFilesContainer = document.getElementById('drive-files');
            const driveBreadcrumbs = document.getElementById('drive-breadcrumbs');

            // --- APPLICATION STATE ---
            let allGames = [];
            let gamesInWheel = [];
            const wheelColors = ["#f72585", "#7209b7", "#00a8f3", "#4a4a5a"];
            let startAngle = 0;
            let arc = 0;
            let isSpinning = false;
            let spinTimeout = null;
            let audioContext;
            let lastTickAngle = 0;

            // --- GOOGLE DRIVE API CONFIGURATION ---
            const API_KEY = 'AIzaSyD-0tLu5kAO9aeSp-5sHoyRcW13_dJXApM'; // <-- IMPORTANT: Replace with your API Key
            const CLIENT_ID = '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'; // <-- IMPORTANT: Replace with your OAuth Client ID
            const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
            let tokenClient;
            let gapiInited = false;
            let gisInited = false;
            let driveFolderHistory = [];

            // --- CORE FUNCTIONS (Existing logic) ---

            function drawRoulette() {
                if (!canvas.getContext) return;
                const outsideRadius = 250;
                const textRadius = 180;
                const insideRadius = 0;
                const imageRadius = 110;
                arc = gamesInWheel.length > 0 ? 2 * Math.PI / gamesInWheel.length : 2 * Math.PI;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (gamesInWheel.length === 0) {
                    ctx.fillStyle = '#2c2c3a';
                    ctx.beginPath();
                    ctx.arc(250, 250, outsideRadius, 0, 2 * Math.PI, false);
                    ctx.fill();
                    ctx.save();
                    ctx.fillStyle = '#f0f0f0';
                    ctx.font = '30px VT323, monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ADD GAMES TO THE WHEEL', 250, 250);
                    ctx.restore();
                    return;
                }
                gamesInWheel.forEach((game, i) => {
                    const angle = startAngle + i * arc;
                    ctx.fillStyle = wheelColors[i % wheelColors.length];
                    ctx.beginPath();
                    ctx.arc(250, 250, outsideRadius, angle, angle + arc, false);
                    ctx.arc(250, 250, insideRadius, angle + arc, angle, true);
                    ctx.strokeStyle = '#1a1a1a';
                    ctx.lineWidth = 8;
                    ctx.stroke();
                    ctx.fill();
                    ctx.save();
                    ctx.fillStyle = '#f0f0f0';
                    ctx.font = 'bold 24px VT323, monospace';
                    ctx.shadowColor = "black"; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2; ctx.shadowBlur = 0;
                    ctx.translate(250 + Math.cos(angle + arc / 2) * textRadius, 250 + Math.sin(angle + arc / 2) * textRadius);
                    ctx.rotate(angle + arc / 2 + Math.PI / 2);
                    const text = game.name.toUpperCase();
                    ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
                    ctx.restore();
                    ctx.save();
                    if (game.image) {
                         ctx.translate(250 + Math.cos(angle + arc / 2) * imageRadius, 250 + Math.sin(angle + arc / 2) * imageRadius);
                        ctx.rotate(angle + arc / 2 + Math.PI / 2);
                        ctx.drawImage(game.image, -30, -40, 60, 80);
                        ctx.strokeStyle = '#f0f0f0'; ctx.lineWidth = 3;
                        ctx.strokeRect(-30, -40, 60, 80);
                    }
                    ctx.restore();
                });
            }

            function displayCoverInGallery(game) {
                const coverDiv = document.createElement('div');
                coverDiv.className = 'cover-item relative group';
                coverDiv.dataset.name = game.name;
                const coverImg = document.createElement('img');
                coverImg.src = game.coverUrl;
                coverImg.alt = game.name;
                coverImg.className = 'w-full h-auto object-cover cursor-pointer';
                coverImg.onerror = () => { coverImg.src = 'https://placehold.co/275x387/2c2c3a/f0f0f0?text=Error'; };
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button absolute top-2 right-2 w-8 h-8 bg-arcade-pink text-arcade-black text-2xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 pixel-button';
                deleteButton.innerHTML = '&times;';
                deleteButton.style.boxShadow = '2px 2px 0px #000';
                deleteButton.addEventListener('click', (event) => { event.stopPropagation(); handleDeleteGame(game.name); });
                coverDiv.appendChild(coverImg);
                coverDiv.appendChild(deleteButton);
                coverDiv.addEventListener('click', () => { toggleGameInWheel(game.name); });
                coversGallery.appendChild(coverDiv);
            }
            
            function handleAddGame() {
                const name = gameNameInput.value.trim();
                const file = gameCoverInput.files[0];
                if (!name || !file) return;
                if (allGames.some(game => game.name.toLowerCase() === name.toLowerCase())) {
                    gameNameInput.style.boxShadow = 'inset 0 0 0 4px #f72585';
                    setTimeout(() => { gameNameInput.style.boxShadow = 'inset 0 0 0 4px #4a4a5a'; }, 2000);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => processAndAddImage(name, e.target.result, file.type);
                reader.readAsDataURL(file);
            }

            function processAndAddImage(name, imageDataUrl, imageType) {
                const originalImage = new Image();
                originalImage.onload = () => {
                    const resizeCanvas = document.createElement('canvas');
                    const targetWidth = 275; const targetHeight = 387;
                    resizeCanvas.width = targetWidth; resizeCanvas.height = targetHeight;
                    const resizeCtx = resizeCanvas.getContext('2d');
                    resizeCtx.drawImage(originalImage, 0, 0, targetWidth, targetHeight);
                    const resizedCoverUrl = resizeCanvas.toDataURL(imageType);
                    const imageForWheel = new Image();
                    imageForWheel.onload = () => {
                        const newGame = { name: name, image: imageForWheel, coverUrl: resizedCoverUrl };
                        allGames.push(newGame);
                        if (!gamesInWheel.some(g => g.name === newGame.name)) {
                            gamesInWheel.push(newGame);
                        }
                        displayCoverInGallery(newGame);
                        saveGamesToStorage();
                        updateGalleryVisuals();
                        drawRoulette();
                        gameNameInput.value = ''; gameCoverInput.value = '';
                    };
                    imageForWheel.src = resizedCoverUrl;
                };
                originalImage.src = imageDataUrl;
            }
            
            function handleDeleteGame(gameName) {
                allGames = allGames.filter(game => game.name !== gameName);
                gamesInWheel = gamesInWheel.filter(game => game.name !== gameName);
                const coverElement = document.querySelector(`.cover-item[data-name="${gameName}"]`);
                if (coverElement) { coverElement.remove(); }
                saveGamesToStorage();
                drawRoulette();
            }

            function toggleGameInWheel(gameName) {
                const gameIndexInWheel = gamesInWheel.findIndex(game => game.name === gameName);
                if (gameIndexInWheel > -1) {
                    gamesInWheel.splice(gameIndexInWheel, 1);
                } else {
                    const gameToAdd = allGames.find(game => game.name === gameName);
                    if (gameToAdd) { gamesInWheel.push(gameToAdd); }
                }
                updateGalleryVisuals();
                drawRoulette();
            }

            function updateGalleryVisuals() {
                document.querySelectorAll('.cover-item').forEach(item => {
                    const gameName = item.dataset.name;
                    item.classList.toggle('in-wheel', gamesInWheel.some(game => game.name === gameName));
                });
            }

            function saveGamesToStorage() {
                const storableList = allGames.map(game => ({ name: game.name, coverUrl: game.coverUrl }));
                localStorage.setItem('fgcRouletteGames', JSON.stringify(storableList));
            }

            function loadGamesFromStorage() {
                const savedGames = localStorage.getItem('fgcRouletteGames');
                if (!savedGames) { drawRoulette(); return; }
                const parsedGames = JSON.parse(savedGames);
                if (parsedGames.length === 0) { drawRoulette(); return; }
                let loadedImagesCount = 0;
                parsedGames.forEach(savedGame => {
                    const img = new Image();
                    img.src = savedGame.coverUrl;
                    const onImageLoadOrError = () => {
                        loadedImagesCount++;
                        if (loadedImagesCount === parsedGames.length) {
                            drawRoulette();
                            updateGalleryVisuals();
                        }
                    };
                    img.onload = () => {
                        const newGame = { name: savedGame.name, image: img, coverUrl: savedGame.coverUrl };
                        allGames.push(newGame);
                        gamesInWheel.push(newGame);
                        displayCoverInGallery(newGame);
                        onImageLoadOrError();
                    };
                    img.onerror = onImageLoadOrError;
                });
            }

            function handleReset() {
                gamesInWheel = [];
                updateGalleryVisuals();
                drawRoulette();
            }

            // --- GOOGLE DRIVE FUNCTIONS ---

            // NEW: Function to check if both APIs are ready
            function checkApisReady() {
                if (gapiInited && gisInited) {
                    driveConnectButton.disabled = false;
                    driveConnectButton.textContent = 'CONNECT TO DRIVE';
                }
            }

            // This function is called when the Google API script is loaded.
            function gapiLoaded() {
                gapi.load('client', initializeGapiClient);
            }

            // Initializes the GAPI client.
            async function initializeGapiClient() {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true;
                checkApisReady(); // Check if ready
            }

            // This function is called when the Google Identity Services script is loaded.
            function gisLoaded() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // Callback is handled by the promise.
                });
                gisInited = true;
                checkApisReady(); // Check if ready
            }

            // Handles the authentication flow.
            function handleAuthClick() {
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    openDriveModal();
                }
            }

            // Opens the Drive modal and fetches root folder contents.
            function openDriveModal() {
                driveModal.classList.remove('hidden');
                listDriveFiles('root', 'My Drive');
            }

            // Lists files and folders from Google Drive.
            async function listDriveFiles(folderId, folderName) {
                driveFilesContainer.innerHTML = '<p class="col-span-full text-center">Loading...</p>';
                
                if (driveFolderHistory.length === 0 || driveFolderHistory[driveFolderHistory.length - 1].id !== folderId) {
                    driveFolderHistory.push({ id: folderId, name: folderName });
                }
                updateBreadcrumbs();

                try {
                    const response = await gapi.client.drive.files.list({
                        'pageSize': 100,
                        'q': `'${folderId}' in parents and (mimeType='application/vnd.google-apps.folder' or mimeType contains 'image/') and trashed=false`,
                        'fields': 'files(id, name, mimeType, iconLink, thumbnailLink)'
                    });
                    
                    driveFilesContainer.innerHTML = '';
                    const files = response.result.files;

                    if (files && files.length > 0) {
                        files.sort((a, b) => {
                            if (a.mimeType === b.mimeType) return a.name.localeCompare(b.name);
                            return a.mimeType === 'application/vnd.google-apps.folder' ? -1 : 1;
                        }).forEach((file) => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'drive-item flex flex-col items-center p-2 text-center';
                            
                            const icon = document.createElement('img');
                            icon.src = file.mimeType === 'application/vnd.google-apps.folder' ? 'https://upload.wikimedia.org/wikipedia/commons/5/59/Google_Drive_Folder_Icon.svg' : file.thumbnailLink;
                            icon.className = 'w-16 h-16 object-contain mb-2';
                            
                            const name = document.createElement('p');
                            name.textContent = file.name;
                            name.className = 'text-sm break-all';
                            
                            fileElement.appendChild(icon);
                            fileElement.appendChild(name);
                            
                            fileElement.onclick = () => {
                                if (file.mimeType === 'application/vnd.google-apps.folder') {
                                    listDriveFiles(file.id, file.name);
                                } else {
                                    addGameFromDrive(file);
                                }
                            };
                            driveFilesContainer.appendChild(fileElement);
                        });
                    } else {
                        driveFilesContainer.innerHTML = '<p class="col-span-full text-center">This folder is empty.</p>';
                    }
                } catch (err) {
                    console.error("Error listing files:", err);
                    driveFilesContainer.innerHTML = `<p class="col-span-full text-center text-arcade-pink">Error: ${err.result.error.message}</p>`;
                     if (err.result.error.status === 'UNAUTHENTICATED') {
                        gapi.client.setToken(null);
                        driveFilesContainer.innerHTML += '<p class="col-span-full text-center">Please connect to Drive again.</p>';
                    }
                }
            }
            
            // Updates the breadcrumb navigation in the Drive modal.
            function updateBreadcrumbs() {
                driveBreadcrumbs.innerHTML = '';
                driveFolderHistory.forEach((folder, index) => {
                    const crumb = document.createElement('span');
                    crumb.className = 'cursor-pointer hover:text-arcade-blue';
                    crumb.textContent = folder.name + (index < driveFolderHistory.length - 1 ? ' >' : '');
                    crumb.onclick = () => {
                        driveFolderHistory = driveFolderHistory.slice(0, index + 1);
                        listDriveFiles(folder.id, folder.name);
                    };
                    driveBreadcrumbs.appendChild(crumb);
                });
            }

            // Fetches an image from Drive and adds it to the game library.
            async function addGameFromDrive(file) {
                const gameName = file.name.replace(/\.[^/.]+$/, "");

                if (allGames.some(game => game.name.toLowerCase() === gameName.toLowerCase())) {
                    // Use a custom modal/alert in the future instead of the browser's default alert
                    alert(`"${gameName}" is already in your library.`);
                    return;
                }

                try {
                    driveFilesContainer.innerHTML = `<p class="col-span-full text-center">Adding ${gameName}...</p>`;
                    const response = await gapi.client.drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    });
                    
                    const blob = new Blob([response.body], { type: file.mimeType });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        processAndAddImage(gameName, e.target.result, file.mimeType);
                        driveModal.classList.add('hidden');
                    };
                    reader.readAsDataURL(blob);

                } catch (err) {
                    console.error("Error fetching file content:", err);
                    alert("Could not add the game. See console for details.");
                }
            }

            // --- SPINNING LOGIC (Existing) ---
            function rotateWheel(spinTime, spinTimeTotal, spinAngleStart) {
                spinTime += 30;
                if (spinTime >= spinTimeTotal) { stopRotateWheel(); return; }
                const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
                startAngle += (spinAngle * Math.PI / 180);
                if (startAngle - lastTickAngle > arc) {
                    playSound('square', 0.05, 800, 0.05);
                    lastTickAngle += arc;
                }
                drawRoulette();
                spinTimeout = requestAnimationFrame(() => rotateWheel(spinTime, spinTimeTotal, spinAngleStart));
            }
            
            function stopRotateWheel() {
                cancelAnimationFrame(spinTimeout);
                isSpinning = false; spinButton.disabled = false;
                if (gamesInWheel.length === 0) return;
                playSound('sine', 0.5, 900, 0.2);
                const degrees = startAngle * 180 / Math.PI + 90;
                const arcd = arc * 180 / Math.PI;
                const index = Math.floor((360 - degrees % 360) / arcd);
                const winner = gamesInWheel[index];
                winnerName.textContent = winner.name;
                winnerCover.src = winner.coverUrl;
                winnerModal.classList.remove('hidden');
            }

            function easeOut(t, b, c, d) {
                const ts = (t /= d) * t; const tc = ts * t;
                return b + c * (tc + -3 * ts + 3 * t);
            }

            function handleSpin() {
                if (isSpinning || gamesInWheel.length < 2) return;
                if (!audioContext) { audioContext = new (window.AudioContext || window.webkitContext)(); }
                isSpinning = true; spinButton.disabled = true;
                const spinAngleStart = Math.random() * 10 + 10;
                const spinTimeTotal = Math.random() * 3000 + 8000; 
                lastTickAngle = startAngle;
                rotateWheel(0, spinTimeTotal, spinAngleStart);
            }
            
            function playSound(type, duration = 0.05, frequency = 800, gain = 0.1) {
                 if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                gainNode.gain.setValueAtTime(gain, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }

            // --- EVENT LISTENERS ---
            addGameButton.addEventListener('click', handleAddGame);
            resetButton.addEventListener('click', handleReset);
            spinButton.addEventListener('click', handleSpin);
            closeModalButton.addEventListener('click', () => winnerModal.classList.add('hidden'));
            winnerModal.addEventListener('click', (e) => { if (e.target === winnerModal) { winnerModal.classList.add('hidden'); } });

            // --- DRIVE EVENT LISTENERS ---
            driveConnectButton.addEventListener('click', () => {
                // The old check is no longer needed here because the button is disabled
                handleAuthClick();
            });
            closeDriveModalButton.addEventListener('click', () => {
                driveModal.classList.add('hidden');
                driveFolderHistory = [];
            });


            // --- INITIALIZATION ---
            loadGamesFromStorage();
        });
    </script>
    <!-- Load Google API scripts after the main script -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
